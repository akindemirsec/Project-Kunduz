package vulnerability

import (
	"fmt"
	"project-kunduz/pkg/db"
	"project-kunduz/pkg/models"
	"strings"
)

func MatchVulnerabilities() {
	var clusters []models.Cluster
	var cves []models.CVE

	db.DB.Preload("SBOMs").Preload("Assets").Find(&clusters)
	db.DB.Find(&cves)

	for _, cluster := range clusters {
		for _, sbom := range cluster.SBOMs {
			for _, cve := range cves {
				if containsVulnerability(sbom.Data, cve.CVEID) {
					alarm := models.Alarm{
						Message:   fmt.Sprintf("Vulnerability %s found in SBOM %s", cve.CVEID, sbom.Name),
						ClusterID: cluster.ID,
					}
					db.DB.Create(&alarm)
				}
			}
		}
		for _, asset := range cluster.Assets {
			for _, cve := range cves {
				if containsVulnerability(asset.Name, cve.CVEID) {
					alarm := models.Alarm{
						Message:   fmt.Sprintf("Vulnerability %s found in Asset %s", cve.CVEID, asset.Name),
						ClusterID: cluster.ID,
					}
					db.DB.Create(&alarm)
				}
			}
		}
	}
}

func containsVulnerability(data string, cveID string) bool {
	return strings.Contains(data, cveID)
}
